
swagger: '2.0'
schemes:
  - http
  - https
host: 54.
basePath: /api/v1/
info:
  description: |
    This is the documentation for the Doxa programming interface.
  version: 0.1.0
  title: Doxa API
  # termsOfService: 'http://swagger.io/terms/'
  # contact:
  #   email: codewiseio@gmail.com
  #   url: ...
  # x-logo:
  #   url: 'https://rebilly.github.io/ReDoc/petstore-logo.png'
  license:
    name: None
    url: ''
# externalDocs:
#   description: Add some external documents here.
#   url: 'https://github.com/Rebilly/generator-openapi-repo'
tags:
  - name: doxa
    description: Common Belief Platform
securityDefinitions:
  Bearer:
    description: |
      Authentication using JWT and the "Authorization: Bearer ..." http headers.
    type: basic
    name: Authorization
    in: header
x-servers:
  - url: //localhost/v1/api
    description: Default server
  # - url: //petstore.swagger.io/sandbox
  #   description: Sandbox server
paths:
  '/authentication':
    post:
      tags:
        - authentication
      summary: Authenticate User
      description: Use an email and password to authenticate and login a user.
      operationId: loginUser
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          description: User credentials
          required: true
          schema:
            type: object
            properties:
              email:
                description: Email address associated with the user
                type: string
                example: test@example.com
              password:
                description: Password
                type: string
                example: secret
      responses:
        '401':
          description: Unauthorized
          schema:
            type: object
            properties:
              status: 
                type: string
                description: Operation status
                example: fail
                default: fail
                enum:
                  - fail
              message: 
                type: string
                description: Message
                example: Invalid credentials
                default: Invalid credentials
        '200':
          description: Success
          schema:
            type: object
            properties:
              token:
                type: string
                description: |
                  Authentication token
              user:
                description: The authenticated user
                allOf:
                  - $ref: '#/definitions/User'
      x-code-samples:
        - lang: 'Angular'
          source: |

            // login and store JWT to local storage
            let credentials = {'email': 'test@example.com', 'password':'secret'};
            this.http.post(`/api/authentication/`, credentials )
               .toPromise()
               .then(
                 (response: any) => {
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    localStorage.setItem('authToken',response.token)
                    return response.user as User;
                 },
                 (response:any) => {
                    console.log('Error: ')
                    console.log(response.status);  // 401 - Unauthorized
                 }
                )

            // later - provide token on http request
            let $token = localStorage.getItem('authToken',response.token)
            let headers = new HttpHeaders({ 'Authorization', `Bearer ${token}` });
            return this.http.post(`/api/endpoint/`, data, { headers: headers} );


    delete:
      tags:
        - authentication
      summary: Logout User
      description: ''
      operationId: logoutUser
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        '204':
          description: Success
        '400':
          description: No authenticated user
      x-code-samples:
        - lang: 'Angular'
          source: |
            this.http.delete(`/api/v1/authentication/` )
               .toPromise()
               .then(
                 (response: any) => {
                    localStorage.setItem('currentUser', null);
                    localStorage.setItem('authToken', null)
                    return response;
                 },
                 (response:any) => {
                    console.log('Error: ')
                    console.log(response.status);  // 400
                 }
                )
    patch:
      tags:
        - authentication
      summary: Activate User
      description: Activate a user using activation string
      operationId: activateUser
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        '200':
          description: Success
          schema:
            type: object
            properties:
              status:
                type: string
                description: Operation status
                example: success
                default: success
                enum:
                  - success
              message:
                type: string
                description: Message
                example: This account is now active.
                default: This account is now active.
        '400':
          description: Fail
          schema:
            type: object
            properties:
              status:
                type: string
                description: Operation status
                example: fail
                default: fail
                enum:
                  - fail
              message:
                type: string
                description: Message
                example: Could not activate user  
                default: Could not activate user  
        '409':
          description: Duplicate request
          schema:
            type: object
            properties:
              status:
                type: string
                description: Operation status
                example: fail
                default: fail
                enum:
                  - fail
              message:
                type: string
                description: Message
                example: This account is already active
                default: This account is already active
      x-code-samples:
        - lang: 'Angular'
          source: |
            this.http.patch(`/api/v1/authentication/`, {'key':'...'} )
               .toPromise()
               .then(
                 (response: any) => {
                    ...success...
                 },
                 (response:any) => {
                    ...error...
                 }
                )
  '/users/':
    post:
      tags:
        - users
      summary: Create User
      description: |
        Unauthenticated users can register for new accounts. New `organization`, `person` and `contact` records will be
        created from supplied data.
      operationId: createUser
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          description: User account
          required: true
          schema:
            type: object
            properties:
              email:
                description: Email address associated with the user
                type: string
                example: test@example.com
              password:
                description: Password
                type: string
                example: secret
              person:
                description: Person
                type: object
                required: true
                $ref: '#/definitions/Person'
              contacts:
                description: Contact Records
                type: array
                items:
                  $ref: '#/definitions/Contact'
              organization:
                description: Organization
                type: object
                required: true
                allOf:
                $ref: '#/definitions/Organization'
      responses:
        '201':
          description: Success
          schema:
            $ref: '#/definitions/User'
        '400':
          description: Fail
          schema:
            type: object
            properties:
              status: 
                type: string
                description: Status
                example: fail
                enum:
                  - fail
              message:
                type: string
                description: Message
                example: User could not be created with received data.
        '409':
          description: Conflict
          schema:
            type: object
            properties:
              status:
                type: string
                description: status
                example: fail
                enum:
                  - fail
              message:
                type: string
                description: Message
                example: This email is already in use.
    get:
      tags:
        - users
      summary: List Users
      description: List and search users. Only available to super users.
      operationId: listUsers
      consumes:
        - application/json
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
            type: array
            items:
              $ref: '#/definitions/User'            
        '403':
          description: Forbidden
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
              message: 
                type: string
                description: Message
  '/users/{moniker}/':
    get:
      tags:
        - users
      summary: Retrieve User
      description: Retrieve user account.
      operatidId: retrieveUser
      consumes:
        - application/json
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
              $ref: '#/definitions/User'            
    patch:
      tags:
        - users
      summary: Update User
      description: |
        Update credentials. You must be logged in and supply your password to make changes. 
        You only need to supply values for the fields you are updating.
      operatidId: updateUser
      consumes:
        - application/json
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
              $ref: '#/definitions/User'
        '401':
          description: Unauthorized
          schema:
              type: object
              properties:
                status:
                  description: Status
                  example: fail
                  enum:
                    - fail
                message:
                   description: Message
                   example: Current password required
    delete:
      tags:
        - users
      summary: Delete User
      description: |
        Delete a user
      operatidId: deleteUser  
      responses:
        '204':
          description: Success
        '401':
          description: Unauthorized
          schema:
              type: object
              properties:
                status:
                  description: Status
                  example: fail
                  default: fail
                  enum:
                    - fail
                message:
                   description: Message
                   example: Current password required
                   default: Current password required
  '/users/password/':
    post:
      tags:
        - users
      summary: Reset Password Request
      description: |
        Request a password reset link be sent to the supplied email address. Links are only valid for 30 minutes.
      operationId: resetPasswordRequest
      consumes:
        - application/json
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - success
                example: success
                default: success
              message: 
                description: Message
                type: string
                example: A password reset link has been sent to this email address.
                default: A password reset link has been sent to this email address.
        '404':
          description: Not found
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: Message
                type: string
                example: No user with this email address.
                default: No user with this email address.
        '400':
          description: Disabled user
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: Message
                type: string
                example: This user has been disabled.
                default: This user has been disabled.
    patch:
      tags:
        - users
      summary: Reset Password
      description: |
        Perform a password reset using a password reset key.
      operationId: resetPassword
      consumes:
        - application/json
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - success
                example: success
                default: success
              message: 
                description: Message
                type: string
                example: Password has been changed.
                default: Password has been changed.
        '404':
          description: Not found
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: Message
                type: string
                example: This password reset key is not valid.
                default: This password reset key is not valid.
        '410':
          description: Expired
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
              message: 
                description: Message
                type: string
                example: This password reset key has expired.
                default: This password reset key has expired.
        '403':
          description: Forbidden
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: message
                type: string
                example: This account has been disabled.
                default: This account has been disabled.
    get:
      tags:
        - users
      summary: Validate Password Reset Key
      description: |
        Check a password reset key for validity, reporting that it is valid,
        expired or used. This is useful when users follow a link from an email. The
        application can then validate the password reset key and provide feedback to the
        user if the link is expired or invalid.
      operationId: validateResetPasswordKey
      produces:
        - application/json      
      responses:
        '200':
          description: Success
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - success
                example: success
                default: success
              message: 
                description: Message
                type: string
                example: Password reset key is valid.
                default: Password reset key is valid.
        '404':
          description: Not found
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: Message
                type: string
                example: This password reset key is not valid.
                default: This password reset key is not valid.
        '410':
          description: Expired
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: Message
                type: string
                example: This password reset key has expired.
                default: This password reset key has expired.
        '403':
          description: Forbidden
          schema:
            type: object
            properties:
              status:
                description: Status
                type: string
                enum:
                  - fail
                example: fail
                default: fail
              message: 
                description: message
                type: string
                example: This account has been disabled.
                default: This account has been disabled.
  /users/email/:
    get:
      tags:
        - users
      summary: Validate Email
      description: |
        Check if the supplied email address is valid and not in use
        by another user.
      operationId: validateEmail
      produces:
        - application/json
      responses:
        '200':
          description: Success
          schema:
            type: object
            properties:
              valid:
                description: Valid
                type: boolean
                enum:
                  - "true"
                  - "false"
                example: "false"
                default: "true"
              message: 
                description: Message
                type: string
                example: This email is already in use.        
                default: This email is already in use.     
definitions:
  
  Id:
    type: integer
    format: int64
  Moniker:
    type: string
  User:
    type: object
    properties:
      moniker:
        description: Moniker
        type: string
        example: user:1
        format: 'entity:id'
      email:
        description: User email address
        type: string
        format: email
        example: john.smith@example.com
      password:
        type: string
        description: 'User password'
        format: password
        minLength: 8
        pattern: '(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])'
        example: drowssaP123
      status:
        description: User status
        type: string
        enum:
          - disabled
          - inactive
          - active
        default: inactive
        example: active
    xml:
      name: User

  Person:
    type: 'object'
    properties:
      moniker:
        description: Moniker
        type: string
        example: 'person:1'
        format: 'entity:id'
      first_name:
        description: First Name
        type: string
        example: Elvis
      middle_name:      
        description: Middle Name
        type: string
        example: Aaraon
      last_name:      
        description: Last Name
        type: string
        example: Presley
      birthday:
        description: Birthday
        type: string
        format: date
        example: '1985-01-08'
      gender:
        description: Gender
        type: string
        format: varchar(1)
        enum:
          - m
          - f
        example: m

  Contact:
    type: object
    properties:
      moniker:
        description: Moniker
        type: string
        example: 'contact:1'
        format: 'entity:id'  
      type:
        description: Type
        type: string
        example: Telephone
        enum:
          - Telephone
          - Email
          - Chat
          - Profile
      label:
        description: Label
        type: string
        example: Home
      value:   
        description: Value
        type: string
        example: '+1 555 555 5555'

  Organization:
    type: object
    properties:
      moniker:
        description: Moniker
        type: string
        example: 'organization:1'
        format: 'entity:id'  
      name:
        description: Name
        type: string
        example: Boy Scouts of America
      description:
        description: description
        type: string
        example: Helping youth is a key to building a more conscientious, responsible and productive society.
  GenericResponse:
    type: object
    properties:
      status:
        type: string
        description: Operation status
        example: success
        enum:
          - success
          - fail
      message:
        type: string
        description: Message
        example: This account is now active.
